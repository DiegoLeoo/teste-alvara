import React, { useState, useEffect, useRef } from 'react';
import { createRoot } from 'react-dom/client';
import { format, addDays } from 'date-fns';
import { ptBR } from 'date-fns/locale';

// Dados para a lista de assinaturas
const signatures = [
  {
    nomeResponsavel: 'Nome do Responsável',
    rg: '00.000.000-0',
    nomeAdvogado: 'Nome do Advogado',
    oab: '00000',
    nomeCompleto: 'Nome do Responsável (Exemplo)',
  },
  {
    nomeResponsavel: 'Carlos Alberto da Silva',
    rg: '12.345.678-9',
    nomeAdvogado: 'Ana Paula Costa',
    oab: '12345',
    nomeCompleto: 'Carlos Alberto da Silva (Advogado)',
  },
  {
    nomeResponsavel: 'Maria Joana Oliveira',
    rg: '98.765.432-1',
    nomeAdvogado: 'João Pedro Santos',
    oab: '54321',
    nomeCompleto: 'Maria Joana Oliveira (Advogado)',
  },
];

// URLs das imagens para o seu projeto. Substitua com suas próprias imagens.
const imageUrls = {
  original: "https://placehold.co/1000x700/D0F0C0/333333?text=Sua+Imagem+de+Licença",
  placeholder: "https://placehold.co/1000x700/D0F0C0/333333?text=Sua+Imagem+de+Licença"
};

const FormPage = ({ onGenerate }) => {
  const [formData, setFormData] = useState({
    licenca: '',
    dataEmissao: format(new Date(), 'yyyy-MM-dd'),
    dataValidade: '',
    endereco: '',
    bairro: '',
    cidadeUf: '',
    razaoSocial: '',
    atividade: '',
    nomeResponsavel: '',
    rg: '',
    nomeAdvogado: '',
    oab: '',
  });

  const [selectedSignature, setSelectedSignature] = useState(signatures[0]);

  // Calcula a data de validade automaticamente
  useEffect(() => {
    if (formData.dataEmissao) {
      const dataEmissaoDate = new Date(formData.dataEmissao);
      const dataValidadeDate = addDays(dataEmissaoDate, 30);
      setFormData(prev => ({
        ...prev,
        dataValidade: format(dataValidadeDate, 'yyyy-MM-dd'),
      }));
    }
  }, [formData.dataEmissao]);

  // Preenche os campos do formulário com a assinatura selecionada
  useEffect(() => {
    if (selectedSignature) {
      setFormData(prev => ({
        ...prev,
        nomeResponsavel: selectedSignature.nomeResponsavel,
        rg: selectedSignature.rg,
        nomeAdvogado: selectedSignature.nomeAdvogado,
        oab: selectedSignature.oab,
      }));
    }
  }, [selectedSignature]);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData({ ...formData, [name]: value });
  };

  const handleSignatureChange = (e) => {
    const selected = signatures.find(s => s.nomeCompleto === e.target.value);
    setSelectedSignature(selected);
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    onGenerate(formData);
  };

  return (
    <div className="min-h-screen bg-gray-100 p-8 flex items-center justify-center">
      <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-4xl">
        <h1 className="text-3xl font-bold text-center text-gray-800 mb-6">Gerador de Licença</h1>
        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div className="space-y-4">
            <h2 className="text-xl font-semibold text-gray-700">Informações da Licença</h2>
            <InputField label="Número da Licença" name="licenca" value={formData.licenca} onChange={handleChange} />
            <InputField label="Data da Emissão" name="dataEmissao" type="date" value={formData.dataEmissao} onChange={handleChange} />
            <InputField label="Data de Validade" name="dataValidade" type="date" value={formData.dataValidade} onChange={handleChange} readOnly />
            <h2 className="text-xl font-semibold text-gray-700 mt-6">Informações da Empresa</h2>
            <InputField label="Razão Social" name="razaoSocial" value={formData.razaoSocial} onChange={handleChange} />
            <InputField label="Atividade da Empresa" name="atividade" value={formData.atividade} onChange={handleChange} />
            <InputField label="Endereço" name="endereco" value={formData.endereco} onChange={handleChange} />
            <InputField label="Bairro" name="bairro" value={formData.bairro} onChange={handleChange} />
            <InputField label="Cidade-UF" name="cidadeUf" value={formData.cidadeUf} onChange={handleChange} />
          </div>
          <div className="space-y-4">
            <h2 className="text-xl font-semibold text-gray-700">Assinatura Digital</h2>
            <div className="flex flex-col">
              <label htmlFor="signature-select" className="block text-sm font-medium text-gray-700 mb-1">
                Escolher Assinatura
              </label>
              <select
                id="signature-select"
                name="assinatura"
                value={selectedSignature.nomeCompleto}
                onChange={handleSignatureChange}
                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2"
              >
                {signatures.map((sig, index) => (
                  <option key={index} value={sig.nomeCompleto}>
                    {sig.nomeCompleto}
                  </option>
                ))}
              </select>
            </div>
            <InputField label="Nome (Responsável da Empresa)" name="nomeResponsavel" value={formData.nomeResponsavel} onChange={handleChange} />
            <InputField label="RG" name="rg" value={formData.rg} onChange={handleChange} />
            <InputField label="Nome (Advogado Solicitante)" name="nomeAdvogado" value={formData.nomeAdvogado} onChange={handleChange} />
            <InputField label="OAB" name="oab" value={formData.oab} onChange={handleChange} />
            <div className="mt-8 pt-4 border-t border-gray-200">
              <button
                type="submit"
                className="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors"
              >
                Gerar Licença
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  );
};

const InputField = ({ label, name, type = 'text', value, onChange, readOnly = false }) => (
  <div className="flex flex-col">
    <label htmlFor={name} className="block text-sm font-medium text-gray-700 mb-1">
      {label}
    </label>
    <input
      id={name}
      name={name}
      type={type}
      value={value}
      onChange={onChange}
      readOnly={readOnly}
      className={`mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 ${readOnly ? 'bg-gray-50' : ''}`}
    />
  </div>
);

const ViewPage = ({ data, onBack }) => {
  const canvasRef = useRef(null);

  useEffect(() => {
    const canvas = canvasRef.current;
    const contexto = canvas.getContext('2d');
    const imagem = new Image();

    imagem.onload = () => {
      canvas.width = imagem.width;
      canvas.height = imagem.height;

      contexto.drawImage(imagem, 0, 0);

      // Definições de estilo para o texto
      contexto.fillStyle = '#000000'; // Cor preta
      contexto.font = '12px Arial';

      // Posicionamento do texto no Canvas
      // Você pode ajustar esses valores (X, Y) para o seu layout
      const textPositions = {
        licenca: { x: 300, y: 150 },
        dataEmissao: { x: 300, y: 170 },
        dataValidade: { x: 300, y: 190 },
        razaoSocial: { x: 300, y: 210 },
        atividade: { x: 300, y: 230 },
        endereco: { x: 300, y: 250 },
        bairro: { x: 300, y: 270 },
        cidadeUf: { x: 300, y: 290 },
        nomeResponsavel: { x: 300, y: 310 },
        rg: { x: 300, y: 330 },
        nomeAdvogado: { x: 300, y: 350 },
        oab: { x: 300, y: 370 },
      };

      // Desenha o texto no canvas
      contexto.fillText(`Número da Licença: ${data.licenca}`, textPositions.licenca.x, textPositions.licenca.y);
      contexto.fillText(`Data da Emissão: ${format(new Date(data.dataEmissao), 'dd/MM/yyyy', { locale: ptBR })}`, textPositions.dataEmissao.x, textPositions.dataEmissao.y);
      contexto.fillText(`Data de Validade: ${format(new Date(data.dataValidade), 'dd/MM/yyyy', { locale: ptBR })}`, textPositions.dataValidade.x, textPositions.dataValidade.y);
      contexto.fillText(`Razão Social: ${data.razaoSocial}`, textPositions.razaoSocial.x, textPositions.razaoSocial.y);
      contexto.fillText(`Atividade: ${data.atividade}`, textPositions.atividade.x, textPositions.atividade.y);
      contexto.fillText(`Endereço: ${data.endereco}`, textPositions.endereco.x, textPositions.endereco.y);
      contexto.fillText(`Bairro: ${data.bairro}`, textPositions.bairro.x, textPositions.bairro.y);
      contexto.fillText(`Cidade-UF: ${data.cidadeUf}`, textPositions.cidadeUf.x, textPositions.cidadeUf.y);
      contexto.fillText(`Responsável: ${data.nomeResponsavel}`, textPositions.nomeResponsavel.x, textPositions.nomeResponsavel.y);
      contexto.fillText(`RG: ${data.rg}`, textPositions.rg.x, textPositions.rg.y);
      contexto.fillText(`Advogado: ${data.nomeAdvogado}`, textPositions.nomeAdvogado.x, textPositions.nomeAdvogado.y);
      contexto.fillText(`OAB: ${data.oab}`, textPositions.oab.x, textPositions.oab.y);

    };

    imagem.onerror = () => {
      // Exibe uma mensagem de erro ou usa uma imagem de placeholder se a URL original falhar
      contexto.font = '20px Arial';
      contexto.fillStyle = 'red';
      contexto.fillText('Erro ao carregar a imagem.', 10, 30);
    };

    imagem.src = imageUrls.original;
  }, [data]);

  return (
    <div className="min-h-screen bg-gray-100 p-8 flex flex-col items-center justify-center">
      <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-4xl">
        <h1 className="text-3xl font-bold text-center text-gray-800 mb-6">Sua Licença Gerada</h1>
        <canvas ref={canvasRef} className="border border-gray-300 rounded-md shadow-inner w-full h-auto"></canvas>
        <button
          onClick={onBack}
          className="mt-6 w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors"
        >
          Voltar para o Formulário
        </button>
      </div>
    </div>
  );
};

const App = () => {
  const [page, setPage] = useState('form');
  const [generatedData, setGeneratedData] = useState(null);

  const handleGenerate = (data) => {
    setGeneratedData(data);
    setPage('view');
  };

  const handleBack = () => {
    setPage('form');
  };

  return (
    <div className="font-sans">
      {page === 'form' ? (
        <FormPage onGenerate={handleGenerate} />
      ) : (
        <ViewPage data={generatedData} onBack={handleBack} />
      )}
    </div>
  );
};

export default App;

